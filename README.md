# LegendsViewer-Next

[![Bay12Forum Thread](https://img.shields.io/badge/Bay12-Forum-blue.svg)](http://www.bay12forums.com/smf/index.php?topic=154617.0)
[![Build and Test](https://github.com/Kromtec/LegendsViewer-Next/actions/workflows/build-and-test.yml/badge.svg)](https://github.com/Kromtec/LegendsViewer-Next/actions/workflows/build-and-test.yml)

LegendsViewer-Next visualizes the history and data generated by **Dwarf Fortress** (including the Steam release). It uses a **.NET 8** backend and **Vue 3 / TypeScript** frontend.

**Features:** World overview with bookmarks and thumbnails, generated maps from XML exports, paginated browsing of sites/entities/figures/events, interactive Leaflet maps, family trees, and efficient loading of large legends XML via XmlReader.

---

## Installation

**Prerequisites:** [.NET 8 SDK](https://dotnet.microsoft.com/download/dotnet/8.0), [Node.js](https://nodejs.org/)

```bash
git clone https://github.com/yourusername/LegendsViewer-Next.git
cd LegendsViewer-Next
dotnet restore
dotnet run
```

The backend builds the Vue frontend and serves it from `legends-viewer-frontend/dist`. Open the URL shown (e.g. `http://localhost:5054` or `http://localhost:8080`).

---

## Development

**Single process (backend hosts frontend):** Run `dotnet run`; change frontend, then rebuild (frontend is built as part of the backend project).

**Two processes (frontend hot reload):**

1. Backend: from repo root, `dotnet run` (API e.g. `http://localhost:5054`).
2. Frontend: `cd LegendsViewer.Frontend/legends-viewer-frontend`, `npm install`, `npm run dev` (Vite e.g. `http://localhost:5173`).

Create `LegendsViewer.Frontend/legends-viewer-frontend/.env.development`:

```
VITE_API_BASE_URL=http://localhost:5054/
```

Use the Vite URL in the browser; API calls go to the backend.

**Local config (optional):** Copy `.env.development.example` to `.env.development` and set `AdminApiKey` for admin features. Or set `AdminApiKey` in `appsettings.Development.json`.

---

## Deployment

### Docker

```bash
docker build -t legendsviewer-next .
docker run -p 8080:8080 -v ./data:/app/data -e AdminApiKey=your-secret legendsviewer-next
```

Or use the included `docker-compose.yml` (mounts `./data` for bookmarks and uploads): `docker-compose up`.

### Fly.io

1. **Install Fly CLI** and sign in: [Install guide](https://fly.io/docs/hands-on/install-flyctl/), then `fly auth login`.

2. **Create app and configure:** From repo root, `fly launch` (or create app manually). Ensure `fly.toml` has:
   - `[build]` with `dockerfile = "Dockerfile"`
   - `[env]` with `ASPNETCORE_ENVIRONMENT=Production`, `ASPNETCORE_URLS=http://0.0.0.0:8080`
   - `[http_service]` with `internal_port = 8080`, `auto_stop_machines = 'stop'`, `auto_start_machines = true`, `min_machines_running = 0`
   - Health check: `[[http_service.checks]]` with `path = "/api/version"`
   - `[[vm]]` with `memory_mb = 512` (or 1024 for large worlds)

3. **Create persistent volume** (same region as app, e.g. `iad`):
   ```bash
   fly volumes create data --size 3 --region iad
   ```

4. **Mount volume** in `fly.toml`:
   ```toml
   [[mounts]]
     source = "data"
     destination = "/app/data"
   ```

5. **Set admin secret:**
   ```bash
   fly secrets set AdminApiKey=your-secret-key
   ```
   Generate a key: `openssl rand -hex 32`. Never commit keys; use secrets in production.

6. **Deploy:** `fly deploy`. Open app: `fly open`. Check status: `fly status`, logs: `fly logs`.

**Fly.io behavior:** Machines are demand-response. With `min_machines_running = 0`, idle machines stop after several minutes. When traffic arrives, a new process starts—**parsed world data is in memory only** and is lost. Bookmarks and uploaded files on the volume persist; after cold start an admin must load a world again. To keep one machine always on: set `min_machines_running = 1` in `fly.toml` (~$4/month for 512MB + ~$0.45 for 3 GB volume in iad).

**Custom domain (optional):** `fly certs add yourdomain.com`, then add the DNS records Fly provides. Verify: `fly certs show yourdomain.com`.

---

## Admin control

Loading worlds and uploading/deleting files require **admin** access. If no admin key is configured, everyone has admin (development only—always set a key in production).

### Configuring the admin key

- **Backend:** Set `AdminApiKey` in `appsettings.json` or `appsettings.Production.json`, or as environment variable (e.g. Fly: `fly secrets set AdminApiKey=...`). For local Docker: use `.env.development` or `docker run -e AdminApiKey=...`.
- **Frontend (for UI):** Admins must provide the key in the browser:
  - **localStorage (recommended):** Browser console: `localStorage.setItem('adminKey', 'your-secret-key')`, then refresh.
  - **Query (testing):** `?adminKey=your-secret-key` on any URL.
  - **API calls:** Header `X-Admin-Key: your-secret-key`.

### Protected endpoints

- `POST /api/Bookmark/loadByFileName` — Load a world
- `DELETE /api/Bookmark/{filePath}` — Delete a bookmark
- `POST /api/FileSystem/upload` — Upload files
- `DELETE /api/FileSystem/{fileName}` — Delete a file

All other endpoints (view bookmarks, explore world data) are public.

### Workflow

1. Admin sets admin key in browser (or sends it with API calls).
2. Admin clicks “Explore a new world” → Upload tab to upload XML files, or Select tab to pick an existing file.
3. Admin selects the main `-legends.xml` file and clicks “Load World.” World is parsed and bookmark is saved.
4. All users can see the bookmark and click “Explore” to view the world. Only one world is “loaded” (in memory) at a time; loading another replaces it.
5. After app restart, bookmarks persist but world data is cleared; admin must click “Load” on a bookmark to re-parse.

### Troubleshooting admin

- **“Explore a new world” button not showing:** Ensure admin key is set in localStorage (or query) and matches server `AdminApiKey`. Refresh. Check `GET /api/Bookmark/isAdmin` returns `true`.
- **Admin key not working:** Verify `AdminApiKey` is set on the server; check Network tab that `X-Admin-Key` is sent on protected requests.

### Security

Use a strong random key (e.g. 32+ chars). Never commit keys. Use environment variables or platform secrets in production. Prefer HTTPS so the key is not sent in cleartext. Rotate keys periodically.

---

## Data, bookmarks, and file uploads

### Data directory

- **Local:** `./data` (or value of `DataDirectory` in config)
- **Docker/Fly:** `/app/data` (mount a volume so data persists)

Contains: `bookmarks.json`, uploaded world files (XML, TXT, BMP). This is the only persistent storage; parsed world data lives only in memory.

### Bookmarks vs loaded world

- **Bookmark (Default):** Metadata only—world name, thumbnail, dimensions, file path—stored in `bookmarks.json`. Persists across restarts. UI shows “Load”; user cannot explore until the world is loaded.
- **Loaded (Loaded):** World XML has been parsed into memory. One world can be loaded at a time. UI shows “Explore”; all users can explore. Loading a different world clears the previous one from memory and sets the new one as loaded.
- **After restart:** All bookmarks revert to Default. Bookmarks and uploaded files remain on disk; parsed data is gone. Admin must click “Load” on a bookmark to re-parse and make that world explorable again.

### File uploads

- **Who:** Admin only. Set admin key in browser first.
- **Where:** “Explore a new world” → Upload tab. Files are stored in the data directory (volume in Docker/Fly).
- **Limits:** 1 GB per file. Allowed types: `.xml`, `.txt`, `.bmp`.
- **Recommended set per world:** `savename-timestamp-legends.xml` (required), `savename-timestamp-legends_plus.xml` (recommended), plus optional `-world_history.txt`, `-world_sites_and_pops.txt`, `-world_map.bmp`.
- **After upload:** Switch to Select tab, choose the `-legends.xml` file, click “Load World.”

**Validation:** Server checks file size, extension, filename (no path traversal), and admin authorization.

### Bookmarks persistence (Docker/Fly)

- Ensure the data directory is mounted (e.g. `-v ./data:/app/data` or Fly volume mounted at `/app/data`). Otherwise bookmarks and uploads are lost on restart.
- **Backup:** `cp ./data/bookmarks.json ./data/bookmarks.json.backup`. Do not use `docker-compose down -v` if you want to keep data (the `-v` removes volumes).

---

## Troubleshooting

- **Bookmarks disappear after rebuild:** Data directory was not mounted or volume was removed. Fix volume mount; restore from backup if you have one.
- **Upload fails 413:** File over 1 GB. Use a smaller export or increase server limits.
- **Upload fails 401:** Admin key missing or wrong. Set `AdminApiKey` on server and provide same key in browser (localStorage or header).
- **Files disappear after restart:** Volume not mounted. Add `[[mounts]]` in `fly.toml` and create the volume; for Docker use `-v ./data:/app/data`.
- **Fly: app crashes or OOM:** Increase `memory_mb` in `fly.toml` (e.g. 1024). Check `fly logs` and `fly status`.
- **Fly: app not reachable:** Confirm `internal_port` in `fly.toml` matches app (8080). Ensure `ASPNETCORE_URLS=http://0.0.0.0:8080` is set.

---

## Data transfer (summary)

Large XML files are never sent to clients; they are parsed on the server. Clients receive JSON (world metadata, paginated lists, map data) and base64-encoded map images. Response compression (Brotli/Gzip) and HTTP caching (e.g. world data 5 min, maps 1 hour) reduce bandwidth. Pagination (default 10 items per page) is used for lists. For very large worlds, initial world payload can be large; future improvements may include lazy-loading site markers or binary map delivery.

---

## Planned / future

- **Multi-world cache:** Cache multiple parsed worlds on the server (keyed by regionId); client sends which world per request. Avoids “single loaded world lost on cold start” and allows multiple worlds without re-upload.
- **Load-on-demand / auto-restore:** Load a world from disk on first request, or restore last-loaded world on startup, so cold starts don’t require a manual Load.
- **Data transfer / UX:** Lazy-load or paginate site markers; serve map images as binary PNG; ETag/304; optional CDN for maps.
- **Fly.io:** Tuning machine size and `min_machines_running` for cost vs availability; optional custom domain (see above).

---

## License

MIT — see [LICENSE](LICENSE).
